name: "KiBot Run"
on:
  workflow_dispatch:
  workflow_call:

jobs:
  quick:
    runs-on: ubuntu-latest
    container: ghcr.io/inti-cmnb/kicad9_auto_full:latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: "0"

      - name: Get full Git description
        id: git_desc
        shell: bash
        run: |
          if git describe --tags --always >/dev/null 2>&1; then
            GIT_DESC=$(git describe --tags --always)
          else
            GIT_DESC="untagged-$(git rev-parse --short HEAD)"
          fi
          echo "desc=$GIT_DESC" >> $GITHUB_OUTPUT
          echo "Git description: $GIT_DESC"

      - name: Get short Git description (safe)
        id: git_desc_short
        shell: bash
        run: |
          if git describe --tags --exact-match >/dev/null 2>&1; then
            GIT_DESC_SHORT=$(git describe --tags --exact-match)
          elif git describe --tags --abbrev=0 >/dev/null 2>&1; then
            BASE=$(git describe --tags --abbrev=0)
            GIT_DESC_SHORT="${BASE}+!"
          else
            # No tags at all â€” fallback to commit hash
            GIT_DESC_SHORT="v0.0.0+$(git rev-parse --short HEAD)"
          fi
          echo "Git description (short): $GIT_DESC_SHORT"
          echo "desc=$GIT_DESC_SHORT" >> $GITHUB_OUTPUT

      - name: Update date in Schematics and PCB files
        shell: bash
        run: |
          DATE=$(date +"%Y-%m-%d")
          ESCAPED=$(printf '%s\n' "$DATE" | sed 's/[&/\]/\\&/g')
          find . -type f \( -name "*.kicad_pcb" -o -name "*.kicad_sch" \) -print0 | while IFS= read -r -d'' file; do
            echo "Updating date in $file"
            sed -i "s/(date \"[^\"]*\")/(date \"$ESCAPED\")/g" "$file"
          done

      - name: Update comment 9 with git commit hash
        shell: bash
        run: |
          GIT_HASH=$(git rev-parse --short HEAD)
          echo "Git hash: $GIT_HASH"
          ESCAPED=$(printf '%s\n' "$GIT_HASH" | sed 's/[&/\]/\\&/g')
          find . -type f \( -name "*.kicad_pcb" -o -name "*.kicad_sch" \) -print0 | while IFS= read -r -d '' file; do
            echo "Updating comment 9 in $file"
            sed -i "s/(comment 9 \"[^\"]*\")/(comment 9 \"$ESCAPED\")/g" "$file"
          done

      - name: Update version in KiCad files
        shell: bash
        run: |
          NEW_VER=${{ steps.git_desc_short.outputs.desc }}
          echo "New version: $NEW_VER"
          ESCAPED=$(printf '%s\n' "$NEW_VER" | sed 's/[.]/\\./g')
          find . -type f \( -name "*.kicad_pcb" -o -name "*.kicad_sch" \) -print0 | while IFS= read -r -d '' file; do
            echo "Updating version in $file"
            sed -i "s/(rev \"[^\"]*\")/(rev \"$ESCAPED\")/g" "$file"
          done

      - name: Generate Fabrication files
        run: |
          kibot -c kibot.yaml --out-dir out

      - name: List Generated files
        run: ls -al out || echo "No output directory found."

      - name: Upload all results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-${{ steps.git_desc.outputs.desc }}-full
          path: out/*

      - name: Upload Schematics
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-${{ steps.git_desc.outputs.desc }}-schematics
          path: out/Schematic/*schematic.pdf

      - name: Upload DigiKey BOM
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-${{ steps.git_desc.outputs.desc }}-marinecircuits-bom-digikey
          path: out/BOM/MarineCircuits/*.csv
